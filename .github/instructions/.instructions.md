# Copilot Instructions for Sidecar Repository

## Project Overview

This is a FastAPI sidecar service that:
- Downloads audio files from AWS S3
- Transcribes audio using OpenAI Whisper API
- Posts structured results back to WordPress

## Technology Stack

- **Python 3.11+**: Core programming language
- **FastAPI**: Web framework for building APIs
- **uvicorn**: ASGI server for running the application
- **boto3**: AWS SDK for Python (S3 operations)
- **aiohttp**: Async HTTP client/server
- **pydantic**: Data validation using Python type hints
- **Docker**: Containerization

## Code Style and Standards

- Follow PEP 8 Python style guidelines
- Use type hints for function parameters and return values
- Use async/await for I/O operations (API calls, S3 operations)
- Keep functions focused and single-purpose
- Use meaningful variable and function names

## Environment Variables

The application relies on these environment variables:
- `AWS_REGION`: AWS region for S3 (default: us-east-1)
- `S3_BUCKET`: S3 bucket name for audio files
- `AWS_ACCESS_KEY_ID`: AWS access key
- `AWS_SECRET_ACCESS_KEY`: AWS secret key
- `OPENAI_API_KEY`: OpenAI API key for Whisper
- `SIDE_CAR_SECRET`: Authentication secret (default: change-me)
- `WP_SIDE_CAR_CALLBACK`: WordPress callback URL
- `WP_SERVER_TOKEN`: Optional WordPress server token

## Security Best Practices

- Never hardcode API keys or secrets in the code
- Always use environment variables for sensitive data
- Validate all incoming requests with the SIDE_CAR_SECRET
- Use HTTPS for all external API calls
- Clean up temporary files after processing
- Handle exceptions gracefully without exposing sensitive information

## Error Handling

- Use FastAPI's HTTPException for API errors
- Provide meaningful error messages without exposing internal details
- Always clean up resources (temp files, directories) in finally blocks or using context managers
- Log errors appropriately for debugging

## API Design

- Use Pydantic models for request/response validation
- Return consistent JSON response structures
- Include proper HTTP status codes (401 for unauthorized, 500 for server errors, 502 for external service errors)
- Document API endpoints with FastAPI's automatic documentation features

## File Management

- Use `tempfile.mkdtemp()` for creating temporary directories
- Always clean up temporary files with `shutil.rmtree()` after processing
- Use `os.path.join()` for cross-platform path handling

## Docker Deployment

- Base image: `python:3.11-slim`
- Includes ffmpeg for audio file processing
- Runs on port 9001
- Single worker configuration (can be adjusted based on load)

## Testing Considerations

- Test S3 download functionality with mocked boto3 clients
- Test OpenAI API integration with mocked responses
- Test WordPress callback with mocked HTTP requests
- Test error handling and cleanup in failure scenarios
- Ensure temporary file cleanup in all code paths

## Dependencies Management

- Keep `requirements.txt` minimal and up-to-date
- Pin major versions but allow minor/patch updates where appropriate
- Document the purpose of each dependency if not obvious

## Making Changes

When making changes to this repository:
1. Ensure backward compatibility with existing API contracts
2. Update environment variable documentation if adding new variables
3. Test error scenarios and edge cases
4. Verify temporary file cleanup
5. Check that async operations use proper error handling
6. Validate that secrets are never logged or exposed in error messages
